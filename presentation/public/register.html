<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Registro - Hub Academia</title>
    <link rel="icon" type="image/png" href="assets/logo.png">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <link rel="stylesheet" href="css/base.css">
    <link rel="stylesheet" href="css/auth.css">
    <link rel="stylesheet" href="css/footer.css">
    <style>
        /* Footer/Layout Adjustments for Auth Page */
        body {
            flex-direction: column;
            gap: 4rem;
            /* Ensure space between content and footer */
        }

        .auth-container {
            margin: auto;
        }
    </style>

    <style>
        .btn-google {
            display: flex;
            align-items: center;
            justify-content: center;
            width: 100%;
            background-color: white;
            color: #374151;
            border: 1px solid #d1d5db;
            border-radius: 0.5rem;
            padding: 0.75rem;
            font-weight: 500;
            font-size: 1rem;
            cursor: pointer;
            transition: all 0.2s;
            margin-bottom: 1rem;
            box-shadow: 0 1px 2px rgba(0, 0, 0, 0.05);
        }

        .btn-google:hover {
            background-color: #f9fafb;
            border-color: #9ca3af;
        }

        .btn-google img {
            width: 20px;
            height: 20px;
            margin-right: 12px;
        }

        .auth-separator {
            display: flex;
            align-items: center;
            text-align: center;
            color: #6b7280;
            font-size: 0.875rem;
            margin: 1.5rem 0;
            position: relative;
        }

        .auth-separator::before,
        .auth-separator::after {
            content: '';
            flex: 1;
            border-bottom: 1px solid #e5e7eb;
        }

        .auth-separator::before {
            margin-right: 0.5rem;
        }

        .auth-separator::after {
            margin-left: 0.5rem;
        }
    </style>
</head>

<body>
    <div class="auth-container">
        <div class="auth-panel-left">
            <a href="/" title="Volver al inicio">
                <img src="/assets/logo.png" alt="Logo Tutor IA" class="logo-img">
            </a>
            <h2>√önete a la Comunidad</h2>
            <p>Crea tu cuenta para acceder a todas las herramientas de aprendizaje y al Tutor IA.</p>
        </div>
        <div class="auth-panel-right">
            <form id="register-form" class="auth-form">
                <h2>Crear Cuenta</h2>
                <p class="form-subtitle">Completa tus datos para registrarte.</p>
                <div id="error-message" class="error-message" style="display:none;"></div>
                <div class="form-group">
                    <label for="name">Nombre Completo</label>
                    <input type="text" id="name" name="name" required autocomplete="name">
                </div>
                <div class="form-group">
                    <label for="email-user">Correo Electr√≥nico</label>
                    <div class="email-input-group" style="display: flex; width: 100%;">
                        <input type="text" id="email-user" name="email-user" required placeholder="usuario"
                            autocomplete="off"
                            style="width: 70%; border-top-right-radius: 0; border-bottom-right-radius: 0; border-right: none;">
                        <select id="email-domain" name="email-domain"
                            style="width: 30%; background-color: #0f172a; border: 1px solid #334155; color: #fff; border-radius: 0 8px 8px 0; padding: 0.75rem 0.5rem; outline: none; cursor: pointer;">
                            <option value="@gmail.com">@gmail.com</option>
                            <option value="@outlook.com">@outlook.com</option>
                            <option value="@hotmail.com">@hotmail.com</option>
                            <option value="@yahoo.com">@yahoo.com</option>
                            <option value="@icloud.com">@icloud.com</option>
                        </select>
                    </div>
                </div>
                <div class="form-group">
                    <label for="password">Contrase√±a</label>
                    <div class="password-input-wrapper">
                        <input type="password" id="password" name="password" required autocomplete="new-password">
                        <button type="button" class="password-toggle-btn" onclick="togglePassword('password')">
                            <i class="fas fa-eye" id="password-toggle-icon"></i>
                        </button>
                    </div>
                    <!-- ‚úÖ NUEVO: Contenedor para los requisitos de la contrase√±a -->
                    <ul id="password-requirements" class="password-requirements-list"></ul>
                </div>
                <div class="form-group">
                    <label for="confirm-password">Confirmar Contrase√±a</label>
                    <div class="password-input-wrapper">
                        <input type="password" id="confirm-password" name="confirm-password" required
                            autocomplete="new-password">
                        <button type="button" class="password-toggle-btn" onclick="togglePassword('confirm-password')">
                            <i class="fas fa-eye" id="confirm-password-toggle-icon"></i>
                        </button>
                    </div>
                    <div id="password-match-error" class="password-match-error">Las contrase√±as no coinciden</div>
                </div>
                <button type="submit" class="btn-primary" id="register-button">Registrarse</button>

                <!-- ‚úÖ SEPARADOR Y BOT√ìN GOOGLE -->
                <div class="auth-separator">o</div>
                <button type="button" class="btn-google" id="google-register-btn">
                    <img src="https://fonts.gstatic.com/s/i/productlogos/googleg/v6/24px.svg" alt="G">
                    Registrarse con Google
                </button>

                <div class="auth-switch-link">
                    ¬øYa tienes una cuenta? <a href="/login.html">Inicia sesi√≥n</a>
                </div>
                <!-- ‚úÖ NUEVO: Enlace para volver al inicio -->
                <div class="auth-switch-link" style="margin-top: 1rem;">
                    <a href="/">Volver al inicio</a>
                </div>
            </form>
        </div>
    </div>

    <!-- Footer Injection -->
    <footer class="main-footer">
        <div class="footer-container">
            <!-- Col 1 -->
            <div class="footer-brand">
                <a href="/" class="footer-logo">
                    <img src="assets/logo.png" alt="Hub Academia Logo">
                    Hub Academia
                </a>
                <p class="footer-slogan">
                    Tu biblioteca acad√©mica potenciada por IA. Estudia sin l√≠mites, aprende a tu ritmo.
                </p>
            </div>

            <!-- Col 2 -->
            <div class="footer-links-col">
                <h4 class="footer-heading">Explorar</h4>
                <ul class="footer-links-list">
                    <li><a href="/" class="footer-link">Inicio</a></li>
                    <li><a href="course.html" class="footer-link">Cursos</a></li>
                    <li><a href="/" class="footer-link">Biblioteca</a></li>
                    <li><a href="pricing.html" class="footer-link">Precios</a></li>
                </ul>
            </div>

            <!-- Col 3 -->
            <div class="footer-links-col">
                <h4 class="footer-heading">Legal y Ayuda</h4>
                <ul class="footer-links-list">
                    <li><a href="privacy.html" class="footer-link">Pol√≠tica de Privacidad</a></li>
                    <li><a href="terms.html" class="footer-link">T√©rminos y Condiciones</a></li>
                    <li><a href="mailto:soporte@hubacademia.com" class="footer-link">Contacto</a></li>
                </ul>
            </div>
        </div>

        <div class="footer-bottom">
            <div class="copyright">
                ¬© 2026 Hub Academia. Todos los derechos reservados.
            </div>
            <div class="footer-socials">
                <a href="#" class="social-link"><i class="fab fa-twitter"></i></a>
                <a href="#" class="social-link"><i class="fab fa-linkedin"></i></a>
                <a href="#" class="social-link"><i class="fab fa-instagram"></i></a>
            </div>
        </div>
    </footer>

    <!-- ‚úÖ SUPABASE JS (Requerido para Google Login) -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script> <!-- ‚úÖ SweetAlert2 -->
    <script src="/js/config.js"></script> <!-- ‚úÖ NUEVO: Configuraci√≥n global -->

    <script src="/js/services/authApiService.js"></script>
    <script src="/js/sessionManager.js"></script>
    <!-- ‚úÖ SCRIPT COMPLETO: Toggle password + validaci√≥n -->
    <script>
        // Funci√≥n para mostrar/ocultar contrase√±a
        function togglePassword(inputId) {
            const input = document.getElementById(inputId);
            const icon = document.getElementById(inputId + '-toggle-icon');

            if (input.type === 'password') {
                input.type = 'text';
                icon.classList.remove('fa-eye');
                icon.classList.add('fa-eye-slash');
            } else {
                input.type = 'password';
                icon.classList.remove('fa-eye-slash');
                icon.classList.add('fa-eye');
            }
        }
    </script>
    <!-- ‚úÖ SCRIPT CORREGIDO Y COMPLETO: Incluye validaci√≥n en tiempo real y env√≠o del formulario -->
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const registerForm = document.getElementById('register-form');
            const passwordInput = document.getElementById('password');
            const confirmPasswordInput = document.getElementById('confirm-password');
            const passwordChecksContainer = document.getElementById('password-requirements');
            const errorDiv = document.getElementById('error-message');
            const registerButton = document.getElementById('register-button');

            // --- 1. L√≥gica de validaci√≥n de contrase√±a en tiempo real ---
            const requirements = {
                length: { text: 'Al menos 8 caracteres', regex: /.{8,}/, el: null },
                uppercase: { text: 'Una letra may√∫scula (A-Z)', regex: /[A-Z]/, el: null },
                lowercase: { text: 'Una letra min√∫scula (a-z)', regex: /[a-z]/, el: null },
                number: { text: 'Al menos un n√∫mero (0-9)', regex: /[0-9]/, el: null },
                pwned: { text: 'No debe ser una contrase√±a com√∫n o filtrada', el: null }
            };

            // Crear los elementos <li> para los requisitos
            passwordChecksContainer.innerHTML = Object.values(requirements)
                .map(req => `<li class="requirement-item">${req.text}</li>`)
                .join('');

            // Guardar referencia a cada <li>
            Object.keys(requirements).forEach((key, index) => {
                requirements[key].el = passwordChecksContainer.children[index];
            });

            let pwnedCheckTimeout;

            passwordInput.addEventListener('input', () => {
                const password = passwordInput.value;

                // Validar requisitos basados en Regex
                for (const key in requirements) {
                    if (requirements[key].regex) {
                        const isValid = requirements[key].regex.test(password);
                        requirements[key].el.classList.toggle('valid', isValid);
                        requirements[key].el.classList.remove('invalid');
                    }
                }

                // Validar si la contrase√±a est√° comprometida (pwned)
                clearTimeout(pwnedCheckTimeout);
                const pwnedRequirement = requirements.pwned;
                pwnedRequirement.el.classList.remove('valid', 'invalid');

                if (password.length >= 8) { // Solo verificar si la contrase√±a tiene una longitud razonable
                    pwnedCheckTimeout = setTimeout(async () => {
                        const isPwned = await AuthApiService.isPasswordPwned(password);
                        pwnedRequirement.el.classList.toggle('valid', !isPwned);
                        pwnedRequirement.el.classList.toggle('invalid', isPwned);
                    }, 500); // Esperar 500ms despu√©s de la √∫ltima pulsaci√≥n
                }
            });

            // ‚úÖ L√ìGICA DE EMAIL COMPUESTO (Usuario + Dominio)
            const emailUserInput = document.getElementById('email-user');
            const emailDomainSelect = document.getElementById('email-domain');

            // Validaci√≥n simple del input usuario
            emailUserInput.addEventListener('input', () => {
                // Eliminar cualquier caracter no v√°lido para email username (ej: espacios, @)
                emailUserInput.value = emailUserInput.value.replace(/[^a-zA-Z0-9._-]/g, '');
            });

            // --- 2. L√≥gica de env√≠o del formulario ---
            registerForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                errorDiv.style.display = 'none';

                // 1. Sanitizaci√≥n de Email (Trim + Concatenaci√≥n)
                if (!emailUserInput.value.trim()) {
                    errorDiv.textContent = "Por favor ingresa tu nombre de usuario de correo.";
                    errorDiv.style.display = 'block';
                    return;
                }
                const email = emailUserInput.value.trim() + emailDomainSelect.value;

                const password = passwordInput.value;
                const confirmPassword = confirmPasswordInput.value;
                const name = document.getElementById('name').value;
                const matchError = document.getElementById('password-match-error');

                // Validar que las contrase√±as coincidan
                if (password !== confirmPassword) {
                    matchError.classList.add('show');
                    confirmPasswordInput.focus();
                    return;
                }
                matchError.classList.remove('show');

                // 2. Prevenci√≥n de Doble Click (UI Feedback)
                registerButton.disabled = true;
                registerButton.innerHTML = '<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> Procesando...';

                try {
                    // Llamada al servicio
                    const response = await AuthApiService.register(name, email, password);

                    // 3. Manejo de Respuesta 201 (Created)
                    if (response.status === 201) {
                        await Swal.fire({
                            title: '¬°Casi listo!',
                            text: 'Hemos enviado un enlace de confirmaci√≥n a tu correo. Verif√≠calo para entrar.',
                            icon: 'success',
                            background: '#1e293b',
                            color: '#f8fafc',
                            confirmButtonText: 'Entendido',
                            confirmButtonColor: '#2563eb'
                        });
                        window.location.href = '/login.html';
                    } else {
                        // Caso borde (ej: 200 si el backend cambia)
                        throw new Error(response.data.message || 'Error inesperado en el registro.');
                    }

                } catch (error) {
                    // 4. Manejo de Error y Reactivaci√≥n
                    console.error('Error Registro:', error);
                    errorDiv.textContent = error.message;
                    errorDiv.style.display = 'block';

                    // Reactivar bot√≥n para reintentar
                    registerButton.disabled = false;
                    registerButton.textContent = 'Registrarse';
                }
            });

            // ‚úÖ L√ìGICA GOOGLE REGISTER (Caso B)
            const googleBtn = document.getElementById('google-register-btn');
            if (googleBtn) {
                googleBtn.addEventListener('click', async () => {
                    console.log('üîµ Iniciando Registro con Google...');

                    if (!window.AppConfig.SUPABASE_URL || window.AppConfig.SUPABASE_URL.includes('INSERT')) {
                        alert('‚ö†Ô∏è Error de Configuraci√≥n: Falta configurar SUPABASE_URL en js/config.js');
                        return;
                    }

                    try {
                        const { createClient } = supabase;
                        const sb = createClient(window.AppConfig.SUPABASE_URL, window.AppConfig.SUPABASE_ANON_KEY);

                        // ‚úÖ Redirigir directamente al dashboard/index porque Google valida el email
                        const redirectUrl = window.location.hostname === 'localhost'
                            ? 'http://localhost:3000/index.html'
                            : `${window.location.origin}/index.html`;

                        const { data, error } = await sb.auth.signInWithOAuth({
                            provider: 'google',
                            options: {
                                redirectTo: redirectUrl
                            }
                        });


                        if (error) throw error;
                        console.log('üü¢ Redirigiendo a Google...', data);

                    } catch (err) {
                        console.error('‚ùå Error Google Register:', err);
                        alert('Error al registrarse con Google: ' + err.message);
                    }
                });
            }
        });
    </script>
</body>

</html>