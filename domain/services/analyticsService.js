const AnalyticsRepository = require('../repositories/analyticsRepository');
const CourseRepository = require('../repositories/courseRepository');
const PythonMLService = require('./pythonMLService'); // ‚úÖ Importamos el nuevo servicio

class AnalyticsService {
    constructor() {
        this.analyticsRepo = new AnalyticsRepository();
        this.courseRepo = new CourseRepository();
    }

    // Registrar b√∫squeda con an√°lisis de intenci√≥n
    async recordSearchWithIntent(query, results, intent = null) {
        await this.analyticsRepo.recordSearch(query, results.length);
        
        // Si no se proporciona intenci√≥n, intentar inferirla
        if (!intent) {
            intent = this.inferIntentFromQuery(query);
        }
        
        console.log(`üìä Analytics: B√∫squeda "${query}" ‚Üí ${intent} (${results.length} resultados)`);
    }

    // Inferir intenci√≥n de la consulta
    inferIntentFromQuery(query) {
        query = query.toLowerCase();
        
        if (query.includes('hora') || query.includes('horario') || query.includes('cu√°ndo')) {
            return 'consulta_horario';
        } else if (query.includes('material') || query.includes('ejercicio') || query.includes('tarea')) {
            return 'solicitar_material';
        } else if (query.includes('qu√© es') || query.includes('que es') || query.includes('explicame') || query.includes('c√≥mo funciona')) {
            return 'duda_teorica';
        } else if (query.includes('examen') || query.includes('parcial') || query.includes('califica')) {
            return 'consulta_evaluacion';
        } else {
            return 'consulta_general';
        }
    }

    // PREDICCI√ìN DE CURSO M√ÅS BUSCADO
    async predictPopularCourse() {
        // ‚úÖ Delegamos la l√≥gica al servicio de Python.
        // Pasamos un query vac√≠o porque solo nos interesa la predicci√≥n general.
        const recommendations = await PythonMLService.getRecommendations('', []);
        return recommendations.popularCourse || { predictedCourse: 'N/A', confidence: 0, reason: 'Servicio ML no disponible' };
    }

    // ‚úÖ NUEVO: PREDICCI√ìN DE TEMA M√ÅS BUSCADO
    async predictPopularTopic() {
        // ‚úÖ Delegamos la l√≥gica al servicio de Python.
        const recommendations = await PythonMLService.getRecommendations('', []);
        return recommendations.popularTopic || { predictedTopic: 'N/A', confidence: 0, reason: 'Servicio ML no disponible' };
    }

    // Obtener analytics completos
    async getCompleteAnalytics() {
        const [searchTrends, chatAnalytics, popularCourse, popularTopic] = await Promise.all([
            this.analyticsRepo.getSearchTrends(10),
            this.analyticsRepo.getChatAnalytics(),
            this.predictPopularCourse(), // Esta funci√≥n ahora llama al servicio de Python
            this.predictPopularTopic()  // Esta tambi√©n
        ]);

        return {
            searchTrends,
            chatAnalytics,
            popularCourse,
            popularTopic, // ‚úÖ Devolvemos el tema popular
            timestamp: new Date().toISOString()
        };
    }

    // Registrar conversaci√≥n del chatbot
    async recordChatInteraction(userMessage, botResponse, intent, confidence) {
        return await this.analyticsRepo.recordChatMessage(
            userMessage, 
            botResponse, 
            intent, 
            confidence
        );
    }

    // Registrar feedback del usuario
    async recordUserFeedback(conversationId, rating, comments) {
        return await this.analyticsRepo.recordFeedback(conversationId, rating, comments);
    }
}

module.exports = AnalyticsService;