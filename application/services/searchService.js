const CourseRepository = require('../../domain/repositories/courseRepository');
const AnalyticsService = require('../../domain/services/analyticsService');
const MLService = require('../../domain/services/mlService'); // ‚úÖ 1. Importar MLService

class SearchService {
    constructor() {
        this.courseRepository = new CourseRepository();
        this.analyticsService = new AnalyticsService();
    }

    /**
     * Orquesta la l√≥gica de b√∫squeda completa.
     * @param {string} query La consulta del usuario.
     * @returns {Promise<object>} Un objeto con los resultados y recomendaciones.
     */
    async searchCourses(query) {
        console.log(`üöÄ SearchService: Iniciando b√∫squeda para "${query}"`);

        // 1. Realizar la b√∫squeda directa en la base de datos
        const directResults = await this.courseRepository.search(query);
        console.log(`üîç Encontrados ${directResults.length} resultados directos.`);

        // 2. Registrar la b√∫squeda para analytics (sin esperar a que termine)
        // Se determina si es una pregunta para el chatbot
        const isEducationalQuery = this.isEducationalQuery(query);
        this.analyticsService.recordSearchWithIntent(query, directResults, isEducationalQuery ? 'duda_teorica' : 'consulta_general');

        // 3. Obtener recomendaciones del servicio de Machine Learning
        const directResultsIds = directResults.map(course => course.courseId);
        
        // ‚úÖ 2. Usar MLService para obtener las recomendaciones desde Python
        const recommendations = await MLService.getRecommendations(query, directResultsIds);
        console.log('üí° Recomendaciones recibidas del servicio de ML:', recommendations);

        // 4. Formatear y devolver la respuesta final
        return {
            searchQuery: query,
            totalResults: directResults.length,
            results: directResults,
            recommendations: recommendations, // recommendations ya tiene el formato { relatedCourses, relatedTopics }
            isEducationalQuery: isEducationalQuery
        };
    }

    /**
     * Determina si una consulta parece ser una pregunta educativa en lugar de una b√∫squeda de curso.
     * @param {string} query La consulta del usuario.
     * @returns {boolean}
     */
    isEducationalQuery(query) {
        const questionWords = ['qu√©', 'que', 'c√≥mo', 'como', 'cu√°l', 'cual', 'cuando', 'd√≥nde', 'donde', 'por qu√©', 'explica', 'define'];
        const lowerCaseQuery = query.toLowerCase();
        // Considera una pregunta si termina en '?' o empieza con una palabra interrogativa y tiene m√°s de 2 palabras.
        return lowerCaseQuery.endsWith('?') || (questionWords.some(word => lowerCaseQuery.startsWith(word)) && lowerCaseQuery.split(' ').length > 2);
    }

    async getAllCourses() {
        return await this.courseRepository.findAll();
    }
}

module.exports = SearchService;